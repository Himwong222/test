<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>測試風險分類過濾器</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .test-result { margin: 10px 0; padding: 10px; }
        .pass { background-color: #d4edda; border-left: 4px solid #28a745; }
        .fail { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        .info { background-color: #d1ecf1; border-left: 4px solid #17a2b8; }
        button { margin: 5px; padding: 8px 16px; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>測試風險分類過濾器功能</h1>
    
    <div class="test-section">
        <h2>測試說明</h2>
        <p>這個測試頁面幫助驗證客戶列表頁面中的風險分類過濾器是否正常工作。</p>
        <p>問題描述：用戶反映在選擇「高風險」、「中風險」、「低風險」時，沒有成功分類客戶。</p>
    </div>
    
    <div class="test-section">
        <h2>測試步驟</h2>
        <ol>
            <li>打開 <a href="customer_list.html" target="_blank">customer_list.html</a></li>
            <li>打開瀏覽器開發者工具（F12）查看控制台</li>
            <li>使用「測試新增」按鈕添加測試客戶（包含不同風險等級）</li>
            <li>在風險分類下拉選單中選擇「高風險」</li>
            <li>檢查控制台輸出，查看過濾邏輯</li>
            <li>檢查表格是否只顯示高風險客戶</li>
            <li>重複測試「中風險」和「低風險」</li>
        </ol>
    </div>
    
    <div class="test-section">
        <h2>預期控制台輸出</h2>
        <p>當選擇「高風險」時，控制台應該顯示：</p>
        <pre>
Updating customer list, total customers: X
Filter settings - Search:  Risk filter: high
Customer: 測試客戶A, Risk: high, matchesSearch: true, matchesRisk: true
Customer: 測試客戶B, Risk: medium, matchesSearch: true, matchesRisk: false
Customer: 測試客戶C, Risk: low, matchesSearch: true, matchesRisk: false
Filtered customers: 1
Filtered customer names: ["測試客戶A"]
        </pre>
    </div>
    
    <div class="test-section">
        <h2>常見問題排查</h2>
        <div class="test-result info">
            <h3>問題1: riskLevel 值不匹配</h3>
            <p>檢查客戶的 <code>riskLevel</code> 屬性值是否為：<code>'high'</code>, <code>'medium'</code>, <code>'low'</code></p>
            <p>過濾器選項的值是：<code>'high'</code>, <code>'medium'</code>, <code>'low'</code>, <code>'all'</code></p>
        </div>
        
        <div class="test-result info">
            <h3>問題2: 事件監聽器未設置</h3>
            <p>檢查 <code>setupEventListeners()</code> 函數中是否有：</p>
            <pre>
document.getElementById('filter-risk').addEventListener('change', updateCustomerList);
            </pre>
        </div>
        
        <div class="test-result info">
            <h3>問題3: 過濾邏輯錯誤</h3>
            <p>檢查 <code>updateCustomerList()</code> 函數中的過濾邏輯：</p>
            <pre>
const matchesRisk = riskFilter === 'all' || customer.riskLevel === riskFilter;
            </pre>
        </div>
    </div>
    
    <div class="test-section">
        <h2>手動測試</h2>
        <button onclick="runManualTest()">運行手動測試</button>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>修復建議</h2>
        <p>如果過濾器仍然不工作，請檢查：</p>
        <ul>
            <li>確保所有客戶都有正確的 <code>riskLevel</code> 屬性</li>
            <li>檢查 <code>getRiskLevel()</code> 函數是否正確計算風險等級</li>
            <li>驗證 <code>saveCustomer()</code> 函數中正確設置了 <code>riskLevel</code></li>
            <li>檢查瀏覽器控制台是否有JavaScript錯誤</li>
        </ul>
    </div>
    
    <script>
        function runManualTest() {
            const results = document.getElementById('test-results');
            results.innerHTML = '';
            
            // 測試1: 檢查函數是否存在
            const test1 = document.createElement('div');
            test1.className = 'test-result';
            
            const requiredFunctions = ['updateCustomerList', 'getRiskLevel', 'calculateChurnProbability'];
            const missingFunctions = [];
            
            for (const funcName of requiredFunctions) {
                if (typeof window[funcName] === 'undefined') {
                    missingFunctions.push(funcName);
                }
            }
            
            if (missingFunctions.length === 0) {
                test1.className += ' pass';
                test1.innerHTML = '<strong>✓ 測試1通過:</strong> 所有必要的JavaScript函數都已定義';
            } else {
                test1.className += ' fail';
                test1.innerHTML = `<strong>✗ 測試1失敗:</strong> 以下函數未定義: ${missingFunctions.join(', ')}`;
            }
            
            results.appendChild(test1);
            
            // 測試2: 檢查風險等級計算
            const test2 = document.createElement('div');
            test2.className = 'test-result';
            
            if (typeof getRiskLevel !== 'undefined') {
                const testCases = [
                    { prob: 70, expected: 'high' },
                    { prob: 60, expected: 'high' },
                    { prob: 50, expected: 'medium' },
                    { prob: 40, expected: 'medium' },
                    { prob: 30, expected: 'low' },
                    { prob: 10, expected: 'low' }
                ];
                
                let allPass = true;
                let testDetails = '';
                
                testCases.forEach(testCase => {
                    const result = getRiskLevel(testCase.prob);
                    const passed = result === testCase.expected;
                    if (!passed) allPass = false;
                    testDetails += `getRiskLevel(${testCase.prob}) = "${result}" ${passed ? '✓' : '✗ (應為 "' + testCase.expected + '")'}<br>`;
                });
                
                if (allPass) {
                    test2.className += ' pass';
                    test2.innerHTML = '<strong>✓ 測試2通過:</strong> 風險等級計算正確<br>' + testDetails;
                } else {
                    test2.className += ' fail';
                    test2.innerHTML = '<strong>✗ 測試2失敗:</strong> 風險等級計算錯誤<br>' + testDetails;
                }
            } else {
                test2.className += ' fail';
                test2.innerHTML = '<strong>✗ 測試2跳過:</strong> getRiskLevel 函數未定義';
            }
            
            results.appendChild(test2);
            
            // 測試3: 檢查過濾邏輯
            const test3 = document.createElement('div');
            test3.className = 'test-result';
            
            const sampleCustomers = [
                { name: '測試A', riskLevel: 'high' },
                { name: '測試B', riskLevel: 'medium' },
                { name: '測試C', riskLevel: 'low' }
            ];
            
            const testLogic = `
// 模擬過濾邏輯
const riskFilter = 'high';
const filtered = sampleCustomers.filter(customer => {
    const matchesRisk = riskFilter === 'all' || customer.riskLevel === riskFilter;
    return matchesRisk;
});
// 結果應該只包含高風險客戶
            `;
            
            test3.innerHTML = `<strong>過濾邏輯測試:</strong><br>
            <pre>${testLogic}</pre>
            <p>如果這個邏輯正確，過濾器應該只顯示匹配風險等級的客戶。</p>`;
            test3.className += ' info';
            
            results.appendChild(test3);
        }
        
        // 頁面加載時運行測試
        window.addEventListener('load', runManualTest);
    </script>
</body>
</html>